CC = @CC@
prefix = /usr/local
bindir = $(prefix)/bin
mandir = $(prefix)/share/man
libdir = $(prefix)/lib
includedir = $(prefix)/include
pkgconfigdir = $(libdir)/pkgconfig
datadir = $(prefix)/share/ptabtools
VERSION = @PACKAGE_VERSION@

LIBXML_CFLAGS = @LIBXML_CFLAGS@
LIBXML_LIBS = @LIBXML_LIBS@

LIBXSLT_CFLAGS = @LIBXSLT_CFLAGS@
LIBXSLT_LIBS = @LIBXSLT_LIBS@

PROGS = @PROGS@
LIBS = libptb.so.$(VERSION) libptb-$(VERSION).a
PROGS_MANPAGES = $(patsubst %,%.1,$(PROGS))
INSTALL = @INSTALL@
CFLAGS = @CFLAGS@ -g -Wall 
CFLAGS += -DHAVE_CONFIG_H=
POPT_LIBS = -lpopt
XSLT_DEFINE = -DMUSICXMLSTYLESHEET=\"$(datadir)/ptbxml2musicxml.xsl\"

PTBSO_OBJS = ptb.o gp.o

all: $(PROGS) $(LIBS)

ptb2xml.o: ptb2xml.c
	$(CC) $(CFLAGS) -c $< $(LIBXSLT_CFLAGS) $(LIBXML_CFLAGS) $(XSLT_DEFINE)

%.o: %.c
	$(CC) $(CFLAGS) -c $< 

libptb.so.$(VERSION): $(PTBSO_OBJS)
	$(CC) -shared $(CFLAGS) -o $@ $^

libptb-$(VERSION).a: $(PTBSO_OBJS)
	$(AR) rs $@ $^

ptb2xml: ptb2xml.o ptb.o
	$(CC) $(LDFLAGS) -o $@ $^ $(POPT_LIBS) $(LIBXML_LIBS) $(LIBXSLT_LIBS)
	
ptb2ascii: ptb2ascii.o ptb.o
	$(CC) $(LDFLAGS) -o $@ $^ $(POPT_LIBS)

ptb2ptb: ptb2ptb.o ptb.o
	$(CC) $(LDFLAGS) -o $@ $^ $(POPT_LIBS)

ptb2ly: ptb2ly.o ptb.o
	$(CC) $(LDFLAGS) -o $@ $^ $(POPT_LIBS)

gp2ly: gp2ly.o gp.o
	$(CC) $(LDFLAGS) -o $@ $^ $(POPT_LIBS)

ptbinfo: ptbinfo.o ptb.o
	$(CC) $(LDFLAGS) -o $@ $^ $(POPT_LIBS)

install: all
	$(INSTALL) $(PROGS) $(DESTDIR)$(bindir)
	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
	$(INSTALL) -m 644 $(PROGS_MANPAGES) $(DESTDIR)$(mandir)/man1
	$(INSTALL) -d $(DESTDIR)$(libdir)
	$(INSTALL) $(LIBS) $(DESTDIR)$(libdir)
	$(INSTALL) -d $(DESTDIR)$(includedir)
	$(INSTALL) -m 644 ptb.h $(DESTDIR)$(includedir)
	$(INSTALL) -m 644 gp.h $(DESTDIR)$(includedir)
	$(INSTALL) -d $(DESTDIR)$(pkgconfigdir)
	$(INSTALL) -m 644 ptabtools.pc $(DESTDIR)$(pkgconfigdir)
	$(INSTALL) -d $(DESTDIR)$(datadir)
	$(INSTALL) -m 644 ptbxml2musicxml.xsl $(DESTDIR)$(datadir)

test:
	$(MAKE) -C test

ctags: tags
tags: *.c *.h
	ctags *.c *.h

clean: 
	rm -f *.o core $(PROGS) $(LIBS)
